<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Заказы</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #f7f7f7; }
    select, button { padding: 0.5rem; margin: 0.5rem 0; width: 100%; max-width: 400px; }
    pre { background: white; padding: 1rem; border: 1px solid #ccc; max-width: 600px; overflow: auto; }
  </style>
</head>
<body>
  <h1>Выбор заказа</h1>
  <select id="orderSelect">
    <option disabled selected>Загрузка заказов...</option>
  </select>
  <pre id="orderDetails"></pre>
  <button onclick="downloadPDF()">Скачать PDF</button>
  <button onclick="sendWhatsApp()">Отправить в WhatsApp</button>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_pXRvdzbuFgLL4upSR8pFOcglKVHLpxVoOLXSopswlDpzg2eNgl4WtziV1hnpHwn3CuWtimsTf-0W/pub?gid=536909118&single=true&output=csv";
    let orders = [];

    async function fetchCSV() {
      const res = await fetch(CSV_URL);
      const text = await res.text();
      const rows = text.trim().split("\n").map(r => r.split(","));
      const header = rows[0];
      orders = rows.slice(1).map(row => {
        let obj = {};
        header.forEach((h, i) => obj[h.trim()] = row[i]?.trim() || "");
        return obj;
      });
      fillSelect();
    }

    function fillSelect() {
      const select = document.getElementById("orderSelect");
      select.innerHTML = '<option disabled selected>Выберите заказ</option>';
      orders.forEach((o, i) => {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = `${o["Имя"]} (${o["Телефон"]}) - ${o["Статус"]}`;
        select.appendChild(option);
      });
      select.addEventListener("change", showOrderDetails);
    }

    function showOrderDetails() {
      const i = document.getElementById("orderSelect").value;
      const order = orders[i];
      let text = "";
      for (let key in order) {
        text += `${key}: ${order[key]}\n`;
      }
      document.getElementById("orderDetails").textContent = text;
    }

    async function downloadPDF() {
      const i = document.getElementById("orderSelect").value;
      if (i === "") return alert("Выберите заказ");
      const order = orders[i];

      const { PDFDocument, rgb } = PDFLib;
      const pdfDoc = await PDFDocument.create();
      const page = pdfDoc.addPage([600, 400]);
      const { width, height } = page.getSize();

      let y = height - 40;
      page.drawText("Заказ покупателя", { x: 50, y, size: 18, color: rgb(0.2, 0.2, 0.6) });
      y -= 30;

      for (let key of ["Имя", "Телефон", "Адрес", "Товары", "Сумма", "Статус"]) {
        page.drawText(`${key}: ${order[key] || "-"}`, { x: 50, y, size: 12 });
        y -= 20;
      }

      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: "application/pdf" });
      saveAs(blob, `Заказ_${order["Имя"] || "покупатель"}.pdf`);
    }

    function sendWhatsApp() {
      const i = document.getElementById("orderSelect").value;
      if (i === "") return alert("Выберите заказ");
      const order = orders[i];
      const phone = order["Телефон"].replace(/[^\d]/g, "");

      const message = `Здравствуйте, ${order["Имя"]}!\nВаш заказ:\n${order["Товары"]}\nСумма: ${order["Сумма"]}\nСтатус: ${order["Статус"]}`;
      const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
      window.open(url, "_blank");
    }

    fetchCSV();
  </script>
</body>
</html>
