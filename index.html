<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 2rem; background: #f9f9f9; }
    input[type="text"] { width: 100%; margin-bottom: 1rem; padding: 0.5rem; }
    .item { margin-bottom: 0.5rem; }
    button { padding: 0.6rem 1rem; margin-right: 1rem; background: #2e7d32; color: white; border: none; border-radius: 4px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  </style>
</head>
<body>
  <h2>–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ PDF-–∑–∞–∫–∞–∑–∞</h2>

  <!-- –í–≤–æ–¥ —Å—Å—ã–ª–∫–∏ –Ω–∞ CSV-—Ñ–∞–π–ª –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã -->
  <input type="text" id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/e/2PACX-1vR_pXRvdzbuFgLL4upSR8pFOcglKVHLpxVoOLXSopswlDpzg2eNgl4WtziV1hnpHwn3CuWtimsTf-0W/pub?gid=536909118&single=true&output=csv" />
  <button onclick="loadCSV()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã</button>

  <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –∑–∞–∫–∞–∑–∞–º–∏ -->
  <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑:</h3>
  <table id="orderTable"></table>

  <h3>–î–∞–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è</h3>
  <input type="text" id="customerName" placeholder="–ò–º—è" />
  <input type="text" id="customerPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" />
  <input type="text" id="customerAddress" placeholder="–ê–¥—Ä–µ—Å" />
  <br><br>
  <button onclick="generatePDF()">–°–æ–∑–¥–∞—Ç—å PDF</button>
  <button onclick="sendWhatsApp()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ WhatsApp</button>

  <script>
    let orders = [];

    // –ó–∞–≥—Ä—É–∑–∫–∞ CSV-—Ñ–∞–π–ª–∞ —Å Google –¢–∞–±–ª–∏—Ü—ã
    function loadCSV() {
      const url = document.getElementById("sheetUrl").value;
      fetch(url)
        .then(res => res.text())
        .then(text => {
          const lines = text.trim().split('\n').slice(1); // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
          orders = lines.map(line => {
            const [name, phone, address, product, price, total, status] = line.split(',');
            return { name, phone, address, product, price, total, status };
          });

          displayOrders();
        })
        .catch(err => alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV: " + err));
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ
    function displayOrders() {
      const table = document.getElementById("orderTable");
      table.innerHTML = `
        <thead>
          <tr>
            <th>–ò–º—è</th>
            <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
            <th>–ê–¥—Ä–µ—Å</th>
            <th>–¢–æ–≤–∞—Ä—ã</th>
            <th>–ò—Ç–æ–≥–æ</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–í—ã–±—Ä–∞—Ç—å</th>
          </tr>
        </thead>
        <tbody>
          ${orders.map((order, index) => `
            <tr>
              <td>${order.name}</td>
              <td>${order.phone}</td>
              <td>${order.address}</td>
              <td>${order.product}</td>
              <td>${order.total}</td>
              <td>${order.status}</td>
              <td><input type="radio" name="order" value="${index}" onclick="selectOrder(${index})" /></td>
            </tr>
          `).join('')}
        </tbody>
      `;
    }

    let selectedOrder = null;

    // –í—ã–±–æ—Ä –∑–∞–∫–∞–∑–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
    function selectOrder(index) {
      selectedOrder = orders[index];
      document.getElementById("customerName").value = selectedOrder.name;
      document.getElementById("customerPhone").value = selectedOrder.phone;
      document.getElementById("customerAddress").value = selectedOrder.address;
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
    function generatePDF() {
      if (!selectedOrder) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑ –∏–∑ —Å–ø–∏—Å–∫–∞.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text(`–ó–∞–∫–∞–∑ –¥–ª—è: ${selectedOrder.name}`, 10, 20);
      doc.text(`–¢–µ–ª–µ—Ñ–æ–Ω: ${selectedOrder.phone}`, 10, 30);
      doc.text(`–ê–¥—Ä–µ—Å: ${selectedOrder.address}`, 10, 40);
      doc.text(`–¢–æ–≤–∞—Ä—ã:`, 10, 55);
      doc.text(`- ${selectedOrder.product} ‚Äî ${selectedOrder.price}`, 10, 65);
      doc.text(`–ò—Ç–æ–≥–æ: ${selectedOrder.total}`, 10, 75);
      doc.save(`–∑–∞–∫–∞–∑_${selectedOrder.name}.pdf`);
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Å—ã–ª–∫–∏ –Ω–∞ WhatsApp
    function sendWhatsApp() {
      if (!selectedOrder) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑ –∏–∑ —Å–ø–∏—Å–∫–∞.");
        return;
      }

      const message = `üõí *–í–∞—à –∑–∞–∫–∞–∑:*\n\nüë§ ${selectedOrder.name}\nüìû ${selectedOrder.phone}\nüè† ${selectedOrder.address}\n\n- ${selectedOrder.product} ‚Äî ${selectedOrder.price}\n\nüí∞ *–ò—Ç–æ–≥–æ: ${selectedOrder.total} ‚Ç∏*`;

      const encoded = encodeURIComponent(message);
      const waLink = `https://wa.me/?text=${encoded}`;
      window.open(waLink, "_blank");
    }
  </script>
</body>
</html>
